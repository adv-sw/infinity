# HG changeset patch
# User stevew <steve@advance-software.com>
# Date 1643035123 0
#      Mon Jan 24 14:38:43 2022 +0000
# Node ID d7fdb6a94428f29336b7ff146fbfe0a8a4cf65aa
# Parent  a1b6a25ae13196a9428d250eb23bae1f92ee5f5f
tidy/factor

diff --git a/dom/base/Element.cpp b/dom/base/Element.cpp
--- a/dom/base/Element.cpp
+++ b/dom/base/Element.cpp
@@ -286,6 +286,37 @@
 }
 
 
+// Robustly revert a full screen exit - code from Document::OnPageHide
+// TODO[FACTOR]: OnPageHide to use this function too.
+void /*GECKO_API*/ Revert_FullScreen(Document *doc)
+{
+   ClearPendingFullscreenRequests(doc);
+
+   if (doc->GetUnretargetedFullScreenElement()) {
+      // If this document was fullscreen, we should exit fullscreen in this
+      // doctree branch. This ensures that if the user navigates while in
+      // fullscreen mode we don't leave its still visible ancestor documents
+      // in fullscreen mode. So exit fullscreen in the document's fullscreen
+      // root document, as this will exit fullscreen in all the root's
+      // descendant documents. Note that documents are removed from the
+      // doctree by the time OnPageHide() is called, so we must store a
+      // reference to the root (in Document::mFullscreenRoot) since we can't
+      // just traverse the doctree to get the root.
+      Document::ExitFullscreenInDocTree(doc);
+
+      // Since the document is removed from the doctree before OnPageHide() is
+      // called, ExitFullscreen() can't traverse from the root down to *this*
+      // document, so we must manually call CleanupFullscreenState() below too.
+      // Note that CleanupFullscreenState() clears Document::mFullscreenRoot,
+      // so we *must* call it after ExitFullscreen(), not before.
+      // OnPageHide() is called in every hidden (i.e. descendant) document,
+      // so calling CleanupFullscreenState() here will ensure all hidden
+      // documents have their fullscreen state reset.
+      doc->CleanupFullscreenState();
+   }
+}
+
+
 static void Gecko_Embed_Inspect(RefPtr<Element> e, bool fullscreen_active)
 {
   if (fullscreen_active)
@@ -296,15 +327,15 @@
     __inspected = nullptr;
   }
 
-   Document* doc = e ? e->OwnerDoc() : nullptr;
+  Document* doc = e ? e->OwnerDoc() : nullptr;
    
-   if (doc)
-   {
-      Gecko_Embed_Fullscreen_Request(doc, fullscreen_active);
-
-      if (!fullscreen_active)
-         doc->UnsetFullscreenElement();
-   }
+  if (doc)
+  {
+     Gecko_Embed_Fullscreen_Request(doc, fullscreen_active);
+
+     if (!fullscreen_active)
+        Revert_FullScreen(doc);        
+  }
 }
 
 
